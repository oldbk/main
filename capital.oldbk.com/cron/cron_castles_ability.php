<?php
	echo "====CASTLE ABILS START======\r\n";

	$castles_ability = array(
		1 => array(
			2525 => 1,
			10101    => 1,
			53   => 1,
			212  => 1,
			5521 => 0,
			5520 => 0,
			5007071=> 1,
			5500 => 1,
			5501 => 0,
			5502 => 0,
			5503 => 0,
			5504 => 1,
			5505 => 0,
			5506 => 0,
			5507 => 0,
			5508 => 1,
			5509 => 0,
			5510 => 0,
			5511 => 0,
			5512 => 1,
			5513 => 0,
			5514 => 0,
			5515 => 0,
			5516 => 1,
			5517 => 0,
			5518 => 0,
			5519 => 0,
		),
		2 => array(
			2525 => 1,
			10101    => 1,
			53   => 1,
			212  => 1,
			5521 => 0,
			5520 => 0,
			5007071=> 1,
			5500 => 1,
			5501 => 1,
			5502 => 0,
			5503 => 0,
			5504 => 1,
			5505 => 1,
			5506 => 0,
			5507 => 0,
			5508 => 1,
			5509 => 1,
			5510 => 0,
			5511 => 0,
			5512 => 1,
			5513 => 1,
			5514 => 0,
			5515 => 0,
			5516 => 1,
			5517 => 1,
			5518 => 0,
			5519 => 0,
		),
		3 => array(
			2525 => 2,
			10101    => 2,
			53   => 2,
			212  => 2,
			5521 => 1,
			5520 => 1,
			5007071=> 2,
			5500 => 2,
			5501 => 1,
			5502 => 1,
			5503 => 0,
			5504 => 2,
			5505 => 1,
			5506 => 1,
			5507 => 0,
			5508 => 2,
			5509 => 1,
			5510 => 1,
			5511 => 0,
			5512 => 2,
			5513 => 1,
			5514 => 1,
			5515 => 0,
			5516 => 2,
			5517 => 1,
			5518 => 1,
			5519 => 0,
		),
		4 => array(
			2525 => 2,
			10101    => 2,
			53   => 2,
			212  => 2,
			5521 => 1,
			5520 => 1,
			5007071=> 2,
			5500 => 2,
			5501 => 2,
			5502 => 1,
			5503 => 1,
			5504 => 2,
			5505 => 2,
			5506 => 1,
			5507 => 1,
			5508 => 2,
			5509 => 2,
			5510 => 1,
			5511 => 1,
			5512 => 2,
			5513 => 2,
			5514 => 1,
			5515 => 1,
			5516 => 2,
			5517 => 2,
			5518 => 1,
			5519 => 1,
		),
		5 => array(
			2525 => 3,
			10101    => 3,
			53   => 3,
			212  => 3,
			5521 => 2,
			5520 => 2,
			5007071=> 3,
			5500 => 3,
			5501 => 2,
			5502 => 2,
			5503 => 2,
			5504 => 3,
			5505 => 2,
			5506 => 2,
			5507 => 2,
			5508 => 3,
			5509 => 2,
			5510 => 2,
			5511 => 2,
			5512 => 3,
			5513 => 2,
			5514 => 2,
			5515 => 2,
			5516 => 3,
			5517 => 2,
			5518 => 2,
			5519 => 2,
		),
		6 => array(
			2525 => 3,
			10101    => 3,
			53   => 3,
			212  => 3,
			5521 => 2,
			5520 => 2,
			5007071=> 3,
			5500 => 3,
			5501 => 3,
			5502 => 3,
			5503 => 3,
			5504 => 3,
			5505 => 3,
			5506 => 3,
			5507 => 3,
			5508 => 3,
			5509 => 3,
			5510 => 3,
			5511 => 3,
			5512 => 3,
			5513 => 3,
			5514 => 3,
			5515 => 3,
			5516 => 3,
			5517 => 3,
			5518 => 3,
			5519 => 3,
		),
		7 => array(
			2525 => 4,
			10101    => 4,
			53   => 4,
			212  => 4,
			5521 => 3,
			5520 => 3,
			5007071=> 4,
			5500 => 4,
			5501 => 4,
			5502 => 4,
			5503 => 4,
			5504 => 4,
			5505 => 4,
			5506 => 4,
			5507 => 4,
			5508 => 4,
			5509 => 4,
			5510 => 4,
			5511 => 4,
			5512 => 4,
			5513 => 4,
			5514 => 4,
			5515 => 4,
			5516 => 4,
			5517 => 4,
			5518 => 4,
			5519 => 4,
		),
		8 => array(
			2525 => 4,
			10101    => 4,
			53   => 4,
			212  => 4,
			5521 => 3,
			5520 => 3,
			5007071=> 4,
			5500 => 4,
			5501 => 4,
			5502 => 4,
			5503 => 4,
			5504 => 4,
			5505 => 4,
			5506 => 4,
			5507 => 4,
			5508 => 4,
			5509 => 4,
			5510 => 4,
			5511 => 4,
			5512 => 4,
			5513 => 4,
			5514 => 4,
			5515 => 4,
			5516 => 4,
			5517 => 4,
			5518 => 4,
			5519 => 4,
		),
		9 => array(
			2525 => 5,
			10101    => 5,
			53   => 5,
			212  => 5,
			5521 => 4,
			5520 => 4,
			5007071=> 5,
			5500 => 5,
			5501 => 5,
			5502 => 5,
			5503 => 5,
			5504 => 5,
			5505 => 5,
			5506 => 5,
			5507 => 5,
			5508 => 5,
			5509 => 5,
			5510 => 5,
			5511 => 5,
			5512 => 5,
			5513 => 5,
			5514 => 5,
			5515 => 5,
			5516 => 5,
			5517 => 5,
			5518 => 5,
			5519 => 5,
		),
		10 => array(
			2525 => 5,
			10101    => 5,
			53   => 5,
			212  => 5,
			5521 => 5,
			5520 => 5,
			5007071=> 5,
			5500 => 5,
			5501 => 5,
			5502 => 5,
			5503 => 5,
			5504 => 5,
			5505 => 5,
			5506 => 5,
			5507 => 5,
			5508 => 5,
			5509 => 5,
			5510 => 5,
			5511 => 5,
			5512 => 5,
			5513 => 5,
			5514 => 5,
			5515 => 5,
			5516 => 5,
			5517 => 5,
			5518 => 5,
			5519 => 5,
		),
		11 => array(
			2525 => 6,
			10101    => 6,
			53   => 6,
			212  => 6,
			5521 => 6,
			5520 => 6,
			5007071=> 6,
			5500 => 6,
			5501 => 6,
			5502 => 6,
			5503 => 6,
			5504 => 6,
			5505 => 6,
			5506 => 6,
			5507 => 6,
			5508 => 6,
			5509 => 6,
			5510 => 6,
			5511 => 6,
			5512 => 6,
			5513 => 6,
			5514 => 6,
			5515 => 6,
			5516 => 6,
			5517 => 6,
			5518 => 6,
			5519 => 6,
		),
		12 => array(
			2525 => 7,
			10101    => 7,
			53   => 7,
			212  => 7,
			5521 => 7,
			5520 => 7,
			5007071=> 7,
			5500 => 7,
			5501 => 7,
			5502 => 7,
			5503 => 7,
			5504 => 7,
			5505 => 7,
			5506 => 7,
			5507 => 7,
			5508 => 7,
			5509 => 7,
			5510 => 7,
			5511 => 7,
			5512 => 7,
			5513 => 7,
			5514 => 7,
			5515 => 7,
			5516 => 7,
			5517 => 7,
			5518 => 7,
			5519 => 7,
		),
		13 => array(
			2525 => 8,
			10101    => 8,
			53   => 8,
			212  => 8,
			5521 => 8,
			5520 => 8,
			5007071=> 8,
			5500 => 8,
			5501 => 8,
			5502 => 8,
			5503 => 8,
			5504 => 8,
			5505 => 8,
			5506 => 8,
			5507 => 8,
			5508 => 8,
			5509 => 8,
			5510 => 8,
			5511 => 8,
			5512 => 8,
			5513 => 8,
			5514 => 8,
			5515 => 8,
			5516 => 8,
			5517 => 8,
			5518 => 8,
			5519 => 8,
		),
		14 => array(
			2525 => 9,
			10101    => 9,
			53   => 9,
			212  => 9,
			5521 => 9,
			5520 => 9,
			5007071=> 9,
			5500 => 9,
			5501 => 9,
			5502 => 9,
			5503 => 9,
			5504 => 9,
			5505 => 9,
			5506 => 9,
			5507 => 9,
			5508 => 9,
			5509 => 9,
			5510 => 9,
			5511 => 9,
			5512 => 9,
			5513 => 9,
			5514 => 9,
			5515 => 9,
			5516 => 9,
			5517 => 9,
			5518 => 9,
			5519 => 9,
		),
		15 => array(
			2525 => 10,
			10101    => 10,
			53   => 10,
			212  => 10,
			5521 => 10,
			5520 => 10,
			5007071=> 10,
			5500 => 10,
			5501 => 10,
			5502 => 10,
			5503 => 10,
			5504 => 10,
			5505 => 10,
			5506 => 10,
			5507 => 10,
			5508 => 10,
			5509 => 10,
			5510 => 10,
			5511 => 10,
			5512 => 10,
			5513 => 10,
			5514 => 10,
			5515 => 10,
			5516 => 10,
			5517 => 10,
			5518 => 10,
			5519 => 10,
		),
		16 => array(
			2525 => 11,
			10101    => 11,
			53   => 11,
			212  => 11,
			5521 => 11,
			5520 => 11,
			5007071=> 11,
			5500 => 11,
			5501 => 11,
			5502 => 11,
			5503 => 11,
			5504 => 11,
			5505 => 11,
			5506 => 11,
			5507 => 11,
			5508 => 11,
			5509 => 11,
			5510 => 11,
			5511 => 11,
			5512 => 11,
			5513 => 11,
			5514 => 11,
			5515 => 11,
			5516 => 11,
			5517 => 11,
			5518 => 11,
			5519 => 11,
		),
		17 => array(
			2525 => 12,
			10101    => 12,
			53   => 12,
			212  => 12,
			5521 => 12,
			5520 => 12,
			5007071=> 12,
			5500 => 12,
			5501 => 12,
			5502 => 12,
			5503 => 12,
			5504 => 12,
			5505 => 12,
			5506 => 12,
			5507 => 12,
			5508 => 12,
			5509 => 12,
			5510 => 12,
			5511 => 12,
			5512 => 12,
			5513 => 12,
			5514 => 12,
			5515 => 12,
			5516 => 12,
			5517 => 12,
			5518 => 12,
			5519 => 12,
		),
		18 => array(
			2525 => 13,
			10101    => 13,
			53   => 13,
			212  => 13,
			5521 => 13,
			5520 => 13,
			5007071=> 13,
			5500 => 13,
			5501 => 13,
			5502 => 13,
			5503 => 13,
			5504 => 13,
			5505 => 13,
			5506 => 13,
			5507 => 13,
			5508 => 13,
			5509 => 13,
			5510 => 13,
			5511 => 13,
			5512 => 13,
			5513 => 13,
			5514 => 13,
			5515 => 13,
			5516 => 13,
			5517 => 13,
			5518 => 13,
			5519 => 13,
		),
		19 => array(
			2525 => 14,
			10101    => 14,
			53   => 14,
			212  => 14,
			5521 => 14,
			5520 => 14,
			5007071=> 14,
			5500 => 14,
			5501 => 14,
			5502 => 14,
			5503 => 14,
			5504 => 14,
			5505 => 14,
			5506 => 14,
			5507 => 14,
			5508 => 14,
			5509 => 14,
			5510 => 14,
			5511 => 14,
			5512 => 14,
			5513 => 14,
			5514 => 14,
			5515 => 14,
			5516 => 14,
			5517 => 14,
			5518 => 14,
			5519 => 14,
		),
		20 => array(
			2525 => 15,
			10101    => 15,
			53   => 15,
			212  => 15,
			5521 => 15,
			5520 => 15,
			5007071=> 15,
			5500 => 15,
			5501 => 15,
			5502 => 15,
			5503 => 15,
			5504 => 15,
			5505 => 15,
			5506 => 15,
			5507 => 15,
			5508 => 15,
			5509 => 15,
			5510 => 15,
			5511 => 15,
			5512 => 15,
			5513 => 15,
			5514 => 15,
			5515 => 15,
			5516 => 15,
			5517 => 15,
			5518 => 15,
			5519 => 15,
		),
		21 => array(
			2525 => 16,
			10101    => 16,
			53   => 16,
			212  => 16,
			5521 => 16,
			5520 => 16,
			5007071=> 16,
			5500 => 16,
			5501 => 16,
			5502 => 16,
			5503 => 16,
			5504 => 16,
			5505 => 16,
			5506 => 16,
			5507 => 16,
			5508 => 16,
			5509 => 16,
			5510 => 16,
			5511 => 16,
			5512 => 16,
			5513 => 16,
			5514 => 16,
			5515 => 16,
			5516 => 16,
			5517 => 16,
			5518 => 16,
			5519 => 16,
		),
		22 => array(
			2525 => 17,
			10101    => 17,
			53   => 17,
			212  => 17,
			5521 => 17,
			5520 => 17,
			5007071=> 17,
			5500 => 17,
			5501 => 17,
			5502 => 17,
			5503 => 17,
			5504 => 17,
			5505 => 17,
			5506 => 17,
			5507 => 17,
			5508 => 17,
			5509 => 17,
			5510 => 17,
			5511 => 17,
			5512 => 17,
			5513 => 17,
			5514 => 17,
			5515 => 17,
			5516 => 17,
			5517 => 17,
			5518 => 17,
			5519 => 17,
		),
		23 => array(
			2525 => 18,
			10101    => 18,
			53   => 18,
			212  => 18,
			5521 => 18,
			5520 => 18,
			5007071=> 18,
			5500 => 18,
			5501 => 18,
			5502 => 18,
			5503 => 18,
			5504 => 18,
			5505 => 18,
			5506 => 18,
			5507 => 18,
			5508 => 18,
			5509 => 18,
			5510 => 18,
			5511 => 18,
			5512 => 18,
			5513 => 18,
			5514 => 18,
			5515 => 18,
			5516 => 18,
			5517 => 18,
			5518 => 18,
			5519 => 18,
		),
		24 => array(
			2525 => 19,
			10101    => 19,
			53   => 19,
			212  => 19,
			5521 => 19,
			5520 => 19,
			5007071=> 19,
			5500 => 19,
			5501 => 19,
			5502 => 19,
			5503 => 19,
			5504 => 19,
			5505 => 19,
			5506 => 19,
			5507 => 19,
			5508 => 19,
			5509 => 19,
			5510 => 19,
			5511 => 19,
			5512 => 19,
			5513 => 19,
			5514 => 19,
			5515 => 19,
			5516 => 19,
			5517 => 19,
			5518 => 19,
			5519 => 19,
		),
		25 => array(
			2525 => 20,
			10101    => 20,
			53   => 20,
			212  => 20,
			5521 => 20,
			5520 => 20,
			5007071=> 20,
			5500 => 20,
			5501 => 20,
			5502 => 20,
			5503 => 20,
			5504 => 20,
			5505 => 20,
			5506 => 20,
			5507 => 20,
			5508 => 20,
			5509 => 20,
			5510 => 20,
			5511 => 20,
			5512 => 20,
			5513 => 20,
			5514 => 20,
			5515 => 20,
			5516 => 20,
			5517 => 20,
			5518 => 20,
			5519 => 20,
		),

	);

	$q = mysql_query('SELECT * FROM oldbk.castles WHERE clanshort != ""');
	if (mysql_num_rows($q) > 0) {
		while($c = mysql_fetch_assoc($q)) {
			$abil[$c['clanshort']]++;
		}
	}


	while(list($k,$v) = each($abil)) {
		// $k - klan
		// $v - kolvo zamvko
		if ($v > 25) $v = 25;
		reset($castles_ability[$v]);
		while(list($ka,$va) = each($castles_ability[$v])) 
		{
			// $ka - номер абилки
			// $va - колво
			// пишем в оба города

		      	$data=mysql_fetch_assoc(mysql_query('SELECT cl.short, cl.rekrut_klan, cl_a.id, cl_a.magic, cl_a.userscount, cl_a.recrut_count
		      	from clans_abil as cl_a
		      	left JOIN clans as cl
		      	ON cl_a.klan = cl.short
		      	WHERE cl.short ="'.$k.'" AND magic = "'.$ka.'" ;'));

	                if($data[recrut_count])
	                {
			                 if(($va-$data[recrut_count])>0)
	                    		{
	                    		//начисление для рекрутов
		                	$recr=mysql_fetch_assoc(mysql_query('SELECT * FROM clans where id="'.$data[rekrut_klan].'" LIMIT 1;'));
		                        $sql2='INSERT `clans_abil`
							(`klan`, `magic`, `count`,`maxcount`)
						 	values("'.$recr[short].'","'.$ka.'",0,'.$data[recrut_count].')
							ON DUPLICATE KEY UPDATE `count` =0 , `maxcount` ='.$data[recrut_count].';';

							$sql_ava2='INSERT avalon.`clans_abil`
							(`klan`, `magic`, `count`,`maxcount`)
						 	values("'.$recr[short].'","'.$ka.'",0,'.$data[recrut_count].')
							ON DUPLICATE KEY UPDATE `count` =0 , `maxcount` ='.$data[recrut_count].';';
							
							$sql_ang2='INSERT angels.`clans_abil`
							(`klan`, `magic`, `count`,`maxcount`)
						 	values("'.$recr[short].'","'.$ka.'",0,'.$data[recrut_count].')
							ON DUPLICATE KEY UPDATE `count` =0 , `maxcount` ='.$data[recrut_count].';';		
												
		                    mysql_query($sql2);
		                    //mysql_query($sql_ava2); 
		                    //mysql_query($sql_ang2); 
		                    $va=$va-$data[recrut_count];
	                    	    } else {
					mysql_query('UPDATE oldbk.clans_abil SET recrut_count = 0 WHERE id = '.$data['id']);
				    }
	                }
	                // остаток для основы
	                
                    	$sql='	INSERT oldbk.`clans_abil` (`klan`, `magic`, `count`,`maxcount`)
				VALUES ("'.$k.'","'.$ka.'",0,'.$va.')
				ON DUPLICATE KEY UPDATE `maxcount` = maxcount+'.$va;

                    	$sqla='	INSERT avalon.`clans_abil` (`klan`, `magic`, `count`,`maxcount`)
				VALUES ("'.$k.'","'.$ka.'",0,'.$va.')
				ON DUPLICATE KEY UPDATE `maxcount` = maxcount+'.$va;
				
			$sqlan=' INSERT angels.`clans_abil` (`klan`, `magic`, `count`,`maxcount`)
				VALUES ("'.$k.'","'.$ka.'",0,'.$va.')
				ON DUPLICATE KEY UPDATE `maxcount` = maxcount+'.$va;				

				mysql_query($sql);
				//mysql_query($sqla);
				//mysql_query($sqlan);			
			



		}
	}

	echo "====CASTLE ABILS END======\r\n";
?>